#define a function to scan vulnerabilities
import nmap
import requests
from config import settings
def scan_vulnerabilities(target_ip, open_port):
    scanner = nmap.PortScanner()  #creating an nmap scanner object
    vuln_results = {} #creating a dictionary to store the vulnerability results
    for port in open_port:
        try:
            scanner.scan(target_ip, str(port), argument = '--script vuln') #using tha scanner object to scan an open port based on a vulnerability script for that port
            service_info = scanner[target_ip]['tcp'][port]
            name = service_info.get('name', '')
            product = service_info.get('product', '')
            version = service_info.get('version', '')
            service_version = f"{product} {version}".strip()
            vulnerabilities = query_vulners(product, version)
            vuln_results[port] = {
                'service': service_version,
                'vulnerabilities': vulnerabilities
            }
        except Exception as e:
            vuln_results[port] = {
                'service': 'Unknown',
                'vulnerabilities': [],
                'error': str(e)
            }
    return vuln_results

def query_vulners(product, version):
    if not product or not version:
        return []
    try:
        url = 'https://vulners.com/api/v3/search/lucene/'
        headers = {'Content-Type': 'application/json'}
        payload = {
            'query': f"{product} {version}",
            'apiKey': settings.vulners_api_key
        }
        response = requests.post(url, json=payload, headers=headers)
        if response.status_code == 200:
            data = response.json()
            vulnerabilities = []
            for item in data.get('data', {}).get('search', []):
                vuln_id = item.get('id', '')
                title = item.get('title', '')
                vulnerabilities.append(f"{vuln_id}: {title}")
            return vulnerabilities
        else:
            return []
    except Exception as e:
        return [f"Error querying Vulners: {e}"]