import nmap
import requests
from config import settings


def scan_vulnerabilities(target_ip, open_ports):
    scanner = nmap.PortScanner()
    vuln_results = {}

    for port in open_ports:
        try:
            # Scan the port for service info and vulnerabilities
            scanner.scan(target_ip, str(port), arguments='-sV --script vuln')
            port_data = scanner[target_ip]['tcp'].get(port, {})

            product = port_data.get('product', '').strip()
            version = port_data.get('version', '').strip()
            name = port_data.get('name', '').strip()

            if product and version:
                service_version = f"{product} {version}"
            elif product:
                service_version = product
            else:
                service_version = name or "Unknown"

            # Query vulnerabilities from Vulners
            vulnerabilities = query_vulners(product, version)

            vuln_results[port] = {
                'service': service_version,
                'vulnerabilities': vulnerabilities
            }

        except Exception as e:
            vuln_results[port] = {
                'service': 'Unknown',
                'vulnerabilities': [],
                'error': str(e)
            }

    return vuln_results


def query_vulners(product, version):
    if not product or not version:
        return ["Insufficient data to query vulnerabilities."]

    try:
        url = 'https://vulners.com/api/v3/search/lucene/'
        headers = {'Content-Type': 'application/json'}
        payload = {
            'query': f"{product} {version}",
            'apiKey': settings.vulners_api_key
        }

        response = requests.post(url, json=payload, headers=headers)
        if response.status_code == 200:
            data = response.json()
            vulnerabilities = []
            for item in data.get('data', {}).get('search', []):
                vuln_id = item.get('id', '').strip()
                title = item.get('title', '').strip()

                # ✅ Only include valid CVE/title results
                if vuln_id and title:
                    vulnerabilities.append(f"{vuln_id}: {title}")

            return vulnerabilities if vulnerabilities else ["No known vulnerabilities found."]
        else:
            return [f"Vulners API returned status code {response.status_code}"]

    except Exception as e:
        return [f"Error querying Vulners: {e}"]

def format_report_table_html(scan_results):
    headers = []
    versions = []
    ports = []
    statuses = []
    details = []

    for port, result in scan_results.items():
        service = result.get('service', 'Unknown')
        version = service.split()[-1] if ' ' in service else 'Unknown'
        name = service.split()[0] if ' ' in service else service

        headers.append(name)
        versions.append(version)
        ports.append(str(port))

        vulns = result.get('vulnerabilities', [])
        if not vulns:
            statuses.append('<span style="color:#28a745;"><b>No vulnerabilities</b></span>')  # 💚 Green
            details.append("<span style='color:#2196F3;'>No issues found</span>")  # 💙 Blue
        elif "Insufficient data" in vulns[0]:
            statuses.append('<span style="color:#2196F3;"><b>Insufficient data</b></span>')  # 💙 Blue
            details.append("<span style='color:#2196F3;'>Couldn’t query CVEs</span>")  # 💙 Blue
        elif "Error" in vulns[0]:
            statuses.append('<span style="color:#f44336;"><b>Error</b></span>')  # ❤️ Red
            details.append(f"<span style='color:#2196F3;'>{vulns[0]}</span>")  # 💙 Blue
        else:
            statuses.append(f'<span style="color:#f44336;"><b>{len(vulns)} found</b></span>')  # ❤️ Red
            details_text = '<br>'.join(vulns[:5]) + ("<br>..." if len(vulns) > 5 else "")
            details.append(f"<span style='color:#2196F3;'>{details_text}</span>")  # 💙 Blue

    html = f"""
    <html>
    <body style="background-color: #f5f5f5; font-family: Arial, sans-serif;">
    <h2 style="color:#007ACC;">Smart Scan Report for Host</h2>
    <table border="1" cellpadding="10" cellspacing="0" style="border-collapse: collapse; border: 2px solid black; width: 100%; font-size: 14px; text-align: center;">
        <tr style="background-color: #007ACC; color: white;">
            <th>Service</th>{''.join(f"<th>{h}</th>" for h in headers)}
        </tr>
        <tr style="background-color: #E3F2FD;">
            <td><b>Version</b></td>{''.join(f"<td style='color:#000000;'>{v}</td>" for v in versions)}  <!-- 🖤 Black -->
        </tr>
        <tr style="background-color: #FAFAFA;">
            <td><b>Port</b></td>{''.join(f"<td style='color:#444;'>{p}</td>" for p in ports)}
        </tr>
        <tr style="background-color: #E3F2FD;">
            <td><b>Status</b></td>{''.join(f"<td>{s}</td>" for s in statuses)}
        </tr>
        <tr style="background-color: #FAFAFA;">
            <td><b>Details</b></td>{''.join(f"<td>{d}</td>" for d in details)}  <!-- 💙 Blue -->
        </tr>
    </table>
    </body>
    </html>
    """
    return html
